{% extends "ox/core/app.html" %}
{% comment %}
Context:
- user_table_headers: headers of user data table
{% endcomment %}
{% load i18n ox_utils %}

{% block app %}
{% with with_panels=1 %}
{{ block.super }}
{% endwith %}
{% endblock %}

{% block app-nav %}
<v-list-subheader class="ml-2">{% trans "Manage Users" %}</v-list-subheader>
<ox-panel-tab name="user-list"></ox-panel-tab>
<ox-panel-tab name="user-edit" auto></ox-panel-tab>
<ox-panel-tab name="user-add"></ox-panel-tab>

<v-list-subheader class="ml-2">{% trans "Manage Groups" %}</v-list-subheader>
<ox-panel-tab name="group-list"></ox-panel-tab>
<ox-panel-tab name="group-edit" auto></ox-panel-tab>
<ox-panel-tab name="group-add"></ox-panel-tab>
{% endblock %}


{% block app-main %}
<ox-panel name="user-list" tabbed
    title="{% trans "All Users" %}" icon="mdi-account"
    :allowed="context.user.can('auth.view_user')"
    >
    <ox-api-data-table :repo="repos.users" :items="users" :headers="{{ user_table_headers|json }}">
        {% block user-list-data-table %}
        <template #item.groups="{item}">
             <v-chip color="primary" v-for="group of item.groups" variant="tonal" class="mr-1">
                 [[ group.name ]]
             </v-chip>
        </template>

        <template #actions="bind">
            {% block user-list-actions %}
            {% include "./widgets/user_actions.html" with bind="bind" %}
            {% endblock %}
        </template>
        {% endblock %}
    </o-api-data-collection>
</ox-panel>

<ox-panel name="user-edit" tabbed
        title="{% trans "Edit User" %}" icon="mdi-account-edit"
        :allowed="context.user.can('auth.change_user')"
        >
    <template #sheet="{panel}">
        {% include "./widgets/user_edit.html" with value="panel.data" %}
    </template>
</ox-panel>

<ox-panel name="user-add" tabbed
        title="{% trans "New User" %}" icon="mdi-account-plus"
        :allowed="context.user.can('auth.add_user')">
    <template #default>
        <ox-account-editor :initial="new context.repos.users.use()"
            @saved="(value) => context.show('user-edit', value)">
        </ox-account-editor>
    </template>
</ox-panel>

<ox-panel name="group-list" tabbed title="{% trans "All Groups" %}" icon="mdi-account-multiple"
        :allowed="context.user.can('auth.view_group')">
    <ox-api-data-table :repo="repos.groups" :items="groups" :headers="{{ group_table_headers|json }}">
        {% block group-list-data-table %}
        <template #actions="bind">
            {% block group-list-actions %}
            {% include "./widgets/group_actions.html" %}
            {% endblock %}
        </template>
        {% endblock %}
    </o-api-data-collection>
</ox-panel>

<ox-panel name="group-add" tabbed
        title="{% trans "New Group" %}" icon="mdi-account-multiple-plus"
        :allowed="context.user.can('auth.add_group')">
    <template #default="{panel}">
        <ox-group-editor
            :initial="new context.repos.groups.use()"
            @saved="(value) => context.show('group-edit', value)">
        </ox-group-editor>
    </template>
</ox-panel>

<ox-panel name="group-edit" tabbed
        title="{% trans "Edit Group" %}" icon="mdi-account-multiple"
        :allowed="context.user.can('auth.change_group')">
    <template #sheet="{panel}">
        {% include "./widgets/group_edit.html" with value="panel.data" %}
    </template>
</ox-panel>
{% endblock %}
