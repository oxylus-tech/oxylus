import{mergeModels as q,inject as E,useModel as D,computed as S,openBlock as o,createBlock as x,unref as e,withCtx as i,createElementVNode as f,createElementBlock as v,Fragment as b,renderList as U,toDisplayString as P,createVNode as r,createTextVNode as T,createCommentVNode as O,reactive as M,createSlots as A,renderSlot as N,defineComponent as K,toRefs as H,useTemplateRef as W,useSlots as Z,normalizeProps as J,guardReactiveProps as Q}from"vue";import{State as X,modelEditor as Y,useModels as ee,models as C,useModelPanelProps as le,api as te}from"ox";import{OxStateAlert as I,OxValidationBtn as L,OxFieldDetails as j,OxModelPanel as se,OxListKanban as ae}from"ox/components";import{f as ne,h as z,i as h,d as $,V as oe,a as re,b as F,c as ue,j as G,e as B}from"./vuetify.js";const ie=(m,c)=>{const p=m.__vccOpts||m;for(const[_,u]of c)p[_]=u;return p},de={class:"border-b-md font-weight-bold"},me={colspan:"6"},pe={class:"text-top"},ve={key:0},ce={colspan:"4"},fe={__name:"OxPermissionsEdit",props:q({user:{type:Object,default:null},group:{type:Object,default:null}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(m){const c=E("repos");E("models");const p=D(m,"modelValue"),_=c.contentTypes.with("permissions").get(),u=Object.groupBy(_,s=>s.app_verbose),d=S(()=>{if(!m.user)return null;const s={},a=c.groups.whereId(m.user.groups_id).get();for(var n of a)for(var l of n.permissions_id)s[l]=[...s[l]||[],n];return s}),V=["View","Add","Change","Delete"],y=["view","add","change","delete"],k=S(()=>{const s=[];for(var a of _){const n=y.map(t=>a.getPermission(t)),l=a.permissions.filter(t=>!y.includes(t.action));s[a.id]={crud:n,extra:l}}return s});return(s,a)=>(o(),x(e(ne),{class:"mb-2",density:"compact"},{default:i(()=>[f("thead",null,[f("tr",de,[a[2]||(a[2]=f("th",{class:"font-weight-bold"},"Element",-1)),(o(),v(b,null,U(V,n=>f("th",null,P(n),1)),64))])]),f("tbody",null,[(o(!0),v(b,null,U(e(u),(n,l)=>(o(),v(b,null,[f("tr",null,[f("th",me,P(l),1)]),(o(!0),v(b,null,U(n,t=>(o(),v(b,null,[f("tr",null,[f("td",pe,P(t.model_verbose),1),(o(!0),v(b,null,U(k.value[t.id].crud,g=>(o(),v("td",null,[r(e(z),{color:"primary",class:"mb-2 d-inline",modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=w=>p.value=w),value:g.id},null,8,["modelValue","value"]),m.user?(o(),v(b,{key:0},[d.value[g.id]?(o(!0),v(b,{key:0},U(d.value[g.id],w=>(o(),x(e(h),{size:"x-small",density:"comfortable","prepend-icon":"mdi-check",class:"mb-2",color:"primary"},{default:i(()=>[T(P(w.name),1)]),_:2},1024))),256)):O("",!0),m.user.is_superuser?(o(),x(e(h),{key:1,size:"x-small",density:"comfortable","prepend-icon":"mdi-check",class:"mb-2",color:"primary"},{default:i(()=>a[3]||(a[3]=[T(" Super User ")])),_:1})):O("",!0)],64)):O("",!0)]))),256))]),k.value[t.id].extra?(o(),v("tr",ve,[a[4]||(a[4]=f("td",null,null,-1)),f("td",ce,[(o(!0),v(b,null,U(k.value[t.id].extra,g=>(o(),v("div",null,[r(e(z),{color:"primary",class:"mb-2",label:g.name,modelValue:s.value,"onUpdate:modelValue":a[1]||(a[1]=w=>s.value=w),value:g.id},null,8,["label","modelValue","value"]),m.user&&d.value[g.id]?(o(!0),v(b,{key:0},U(d.value[g.id],w=>(o(),x(e(h),{size:"x-small",density:"comfortable","prepend-icon":"mdi-check",class:"mb-2",color:"primary"},{default:i(()=>[T(P(w.name),1)]),_:2},1024))),256)):O("",!0)]))),256))])])):O("",!0)],64))),256))],64))),256))])]),_:1}))}},ye=ie(fe,[["__scopeId","data-v-87066c0d"]]),Ve={class:"text-right mt-3"},be={__name:"OxPasswordEdit",props:{user:{type:Object}},emits:["save","saved"],setup(m,{emit:c}){const p=E("repos"),_=m,u=M({value:"",show:!1}),d=M({value:"",show:!1}),V=M(new X),y=S(()=>u.value&&d.value&&u.value==d.value);function k(){u.value="",d.value="",V.none()}async function s(){V.processing();try{const a=await p.users.api().updatePassword(_.user.id,u.value);a.response.status==200?(u.value="",d.value="",V.ok(a.response)):V.error(a.response.data)}catch(a){V.error((a==null?void 0:a.message)||a)}}return(a,n)=>(o(),v(b,null,[r(e(I),{state:V},null,8,["state"]),r($,{variant:"underlined",label:"Enter password",modelValue:u.value,"onUpdate:modelValue":n[0]||(n[0]=l=>u.value=l),type:u.value?"text":"password","append-icon":u.value?"mdi-eye":"mdi-eye-off","onClick:append":n[1]||(n[1]=l=>u.value=!u.value)},null,8,["modelValue","type","append-icon"]),r($,{variant:"underlined",label:"Confirm password",modelValue:d.value,"onUpdate:modelValue":n[2]||(n[2]=l=>d.value=l),color:y.value?"success":"error",type:d.show?"text":"password","append-icon":d.show?"mdi-eye":"mdi-eye-off","onClick:append":n[3]||(n[3]=l=>d.show=!d.show)},A({_:2},[(u.value||d.value)&&!y.value?{name:"details",fn:i(()=>[n[6]||(n[6]=f("div",{class:"password-error"},"Provided passwords are not the same.",-1))]),key:"0"}:void 0]),1032,["modelValue","color","type","append-icon"]),f("div",Ve,[N(a.$slots,"default",{valid:y.value,value:u.value},()=>[u.value?(o(),x(e(L),{key:0,onValidate:n[4]||(n[4]=l=>s()),onReset:n[5]||(n[5]=l=>k()),state:V,"validate-disabled":!y.value},null,8,["state","validate-disabled"])):O("",!0)])])],64))}},_e={class:"mb-3"},R=K({__name:"OxUserEdit",props:{initial:Object,saved:Function},emits:["saved"],setup(m,{emit:c}){const p=c,_=E("repos"),u=_.groups.all(),d=m,{initial:V}=H(d),y=W("form"),k=E("panel"),s=Y({name:"account-editor",panel:k,initial:V,emits:p,repo:_.users});function a(n){return/^[A-Za-z0-9@.+\-_]+$/.test(n)||"Username must not be empty. It only can contain letters, numbers and @/+/./- special characters"}return(n,l)=>(o(),x(oe,null,{default:i(()=>[r(e(I),{state:e(s).state},null,8,["state"]),f("div",_e,[e(s).edited?(o(),x(e(L),{key:0,onValidate:l[0]||(l[0]=t=>e(s).save()),onReset:l[1]||(l[1]=t=>e(s).reset()),state:e(s).state,"validate-disabled":!e(y).isValid},null,8,["state","validate-disabled"])):O("",!0)]),r(re,{mandatory:"",multiple:"","model-value":["info"]},{default:i(()=>[r(F,{title:"Information",value:"info"},{text:i(()=>[r(ue,{ref_key:"form",ref:y,modelValue:e(s).valid,"onUpdate:modelValue":l[7]||(l[7]=t=>e(s).valid=t)},{default:i(()=>[r($,{variant:"underlined",label:"User Name",modelValue:e(s).value.username,"onUpdate:modelValue":l[2]||(l[2]=t=>e(s).value.username=t),rules:[a]},{details:i(()=>{var t;return[r(e(j),{errors:(t=e(s).errors)==null?void 0:t.username},null,8,["errors"])]}),_:1},8,["modelValue","rules"]),r($,{variant:"underlined",label:"First Name",modelValue:e(s).value.first_name,"onUpdate:modelValue":l[3]||(l[3]=t=>e(s).value.first_name=t)},{details:i(()=>{var t;return[r(e(j),{errors:(t=e(s).errors)==null?void 0:t.first_name},null,8,["errors"])]}),_:1},8,["modelValue"]),r($,{variant:"underlined",label:"Last Name",modelValue:e(s).value.last_name,"onUpdate:modelValue":l[4]||(l[4]=t=>e(s).value.last_name=t)},{details:i(()=>{var t;return[r(e(j),{errors:(t=e(s).errors)==null?void 0:t.last_name},null,8,["errors"])]}),_:1},8,["modelValue"]),r($,{variant:"underlined",type:"email",label:"Email",modelValue:e(s).value.email,"onUpdate:modelValue":l[5]||(l[5]=t=>e(s).value.email=t)},{details:i(()=>{var t;return[r(e(j),{errors:(t=e(s).errors)==null?void 0:t.email},null,8,["errors"])]}),_:1},8,["modelValue"]),r(G,{multiple:"",label:"Groups",modelValue:e(s).value.groups_id,"onUpdate:modelValue":l[6]||(l[6]=t=>e(s).value.groups_id=t),items:e(u),"item-title":"name","item-value":"id"},null,8,["modelValue","items"])]),_:1},8,["modelValue"])]),_:1}),e(s).value.id?(o(),x(F,{key:0,title:"User permissions"},{text:i(()=>[r(B,null,{default:i(()=>[r(ye,{user:e(s).value,modelValue:e(s).value.permissions_id,"onUpdate:modelValue":l[8]||(l[8]=t=>e(s).value.permissions_id=t)},null,8,["user","modelValue"])]),_:1})]),_:1})):O("",!0),e(s).value.id?(o(),x(F,{key:1,title:"Password reset"},{text:i(()=>[r(B,null,{default:i(()=>[r(be,{user:d.initial,onSaved:l[9]||(l[9]=()=>{})},null,8,["user"])]),_:1})]),_:1})):O("",!0)]),_:1})]),_:1}))}});function ge(m=[]){const{repos:c,models:p}=ee([C.User,C.Group,C.Permission,C.ContentType,...m]);return c.contentTypes.api().get("ox/core/content_type/"),c.permissions.api().get("ox/core/permission/"),{repos:c,models:p}}const xe={__name:"OxUserPanel",props:le({name:"user-panel",relations:["groups"],headers:[{key:"id",title:"Id"},{key:"username",title:"Username"},{key:"first_name",title:"First_name"},{key:"last_name",title:"Last_name"},{key:"email",title:"Email"},{key:"groups",title:"Groups"}]}),setup(m){const c=E("context"),p=Z(),_=Object.keys(p).filter(a=>!["list.filters","item.groups"].includes(a)),{repos:u,models:d}=ge();te.query(u)("groups").all({dataKey:"results"});const y=S(()=>u.groups.all()),k=S(()=>[{title:"Without group",value:null},...y.value.map(a=>({title:a.name,value:a.id}))]),s=m;return(a,n)=>(o(),x(e(se),{name:s.name,tabbed:s.tabbed,icon:"mdi-account",repo:e(u).users,headers:s.headers,relations:s.relations,search:"search"},A({"list.filters":i(({list:l,filters:t})=>[r(G,{class:"ml-3",density:"compact",modelValue:t.groups__id__in,"onUpdate:modelValue":g=>t.groups__id__in=g,multiple:"",label:"Groups",items:y.value,"item-title":"$title","item-value":"id","hide-details":""},null,8,["modelValue","onUpdate:modelValue","items"]),N(a.$slots,"list.filters",{list:l,filters:t})]),"views.list.kanban":i(({panel:l,items:t,list:g})=>[r(e(ae),{items:t,field:"groups_id",headers:k.value,"item-title":"username",onClick:w=>l.reset(".edit",w)},null,8,["items","headers","onClick"])]),_:2},[U(e(_),l=>({name:l,fn:i(t=>[N(a.$slots,l,J(Q(t)))])})),e(p)["item.groups"]?void 0:{name:"item.groups",fn:i(({item:l})=>[(o(!0),v(b,null,U(l.groups,t=>(o(),x(h,{color:"primary",variant:"tonal",class:"mr-2"},{default:i(()=>[T(P(t.name),1)]),_:2},1024))),256))]),key:"0"},!e(p)["views.add"]&&e(c).user.can("auth.add_user")?{name:"views.add",fn:i(({value:l,saved:t})=>[r(R,{initial:l,onSaved:t},null,8,["initial","onSaved"])]),key:"1"}:void 0,e(c).user.can("auth.change_user")?{name:"views.edit.window.default",fn:i(({value:l})=>[r(R,{initial:l},null,8,["initial"])]),key:"2"}:void 0]),1032,["name","tabbed","repo","headers","relations"]))}},Pe=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"}));export{ye as O,R as _,xe as a,Pe as b,ge as u};
//# sourceMappingURL=OxUserPanel.js.map
