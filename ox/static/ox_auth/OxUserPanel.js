import{mergeModels as G,inject as S,useModel as K,computed as C,openBlock as n,createBlock as x,unref as e,withCtx as i,createElementVNode as V,createElementBlock as v,Fragment as b,renderList as k,toDisplayString as U,createVNode as r,createTextVNode as j,createCommentVNode as O,reactive as M,createSlots as A,renderSlot as z,defineComponent as q,toRefs as H,useTemplateRef as W,useSlots as Z,normalizeProps as J,guardReactiveProps as Q}from"vue";import{State as X,modelEditor as Y,useModels as ee,models as E,panels as le,query as te}from"ox";import{OxStateAlert as I,OxValidationBtn as L,OxFieldDetails as h,OxModelPanel as se,OxListKanban as ae}from"ox/components";import{f as oe,h as B,i as T,d as $,V as ne,a as re,b as N,c as ue,j as D,e as F}from"./vuetify.js";const ie=(m,c)=>{const p=m.__vccOpts||m;for(const[_,u]of c)p[_]=u;return p},de={class:"border-b-md font-weight-bold"},me={colspan:"6"},pe={class:"text-top"},ve={key:0},ce={colspan:"4"},fe={__name:"OxPermissionsEdit",props:G({user:{type:Object,default:null},group:{type:Object,default:null}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(m){const c=S("repos");S("models");const p=K(m,"modelValue"),_=c.contentTypes.with("permissions").get(),u=Object.groupBy(_,l=>l.app_verbose),d=C(()=>{if(!m.user)return null;const l={},o=c.groups.whereId(m.user.groups_id).get();for(var s of o)for(var t of s.permissions_id)l[t]=[...l[t]||[],s];return l}),f=["View","Add","Change","Delete"],y=["view","add","change","delete"],g=C(()=>{const l=[];for(var o of _){const s=y.map(a=>o.getPermission(a)),t=o.permissions.filter(a=>!y.includes(a.action));l[o.id]={crud:s,extra:t}}return l});return(l,o)=>(n(),x(e(oe),{class:"mb-2",density:"compact"},{default:i(()=>[V("thead",null,[V("tr",de,[o[2]||(o[2]=V("th",{class:"font-weight-bold"},"Element",-1)),(n(),v(b,null,k(f,s=>V("th",null,U(s),1)),64))])]),V("tbody",null,[(n(!0),v(b,null,k(e(u),(s,t)=>(n(),v(b,null,[V("tr",null,[V("th",me,U(t),1)]),(n(!0),v(b,null,k(s,a=>(n(),v(b,null,[V("tr",null,[V("td",pe,U(a.model_verbose),1),(n(!0),v(b,null,k(g.value[a.id].crud,w=>(n(),v("td",null,[r(e(B),{color:"primary",class:"mb-2 d-inline",modelValue:p.value,"onUpdate:modelValue":o[0]||(o[0]=P=>p.value=P),value:w.id},null,8,["modelValue","value"]),m.user?(n(),v(b,{key:0},[d.value[w.id]?(n(!0),v(b,{key:0},k(d.value[w.id],P=>(n(),x(e(T),{size:"x-small",density:"comfortable","prepend-icon":"mdi-check",class:"mb-2",color:"primary"},{default:i(()=>[j(U(P.name),1)]),_:2},1024))),256)):O("",!0),m.user.is_superuser?(n(),x(e(T),{key:1,size:"x-small",density:"comfortable","prepend-icon":"mdi-check",class:"mb-2",color:"primary"},{default:i(()=>o[3]||(o[3]=[j(" Super User ")])),_:1})):O("",!0)],64)):O("",!0)]))),256))]),g.value[a.id].extra?(n(),v("tr",ve,[o[4]||(o[4]=V("td",null,null,-1)),V("td",ce,[(n(!0),v(b,null,k(g.value[a.id].extra,w=>(n(),v("div",null,[r(e(B),{color:"primary",class:"mb-2",label:w.name,modelValue:l.value,"onUpdate:modelValue":o[1]||(o[1]=P=>l.value=P),value:w.id},null,8,["label","modelValue","value"]),m.user&&d.value[w.id]?(n(!0),v(b,{key:0},k(d.value[w.id],P=>(n(),x(e(T),{size:"x-small",density:"comfortable","prepend-icon":"mdi-check",class:"mb-2",color:"primary"},{default:i(()=>[j(U(P.name),1)]),_:2},1024))),256)):O("",!0)]))),256))])])):O("",!0)],64))),256))],64))),256))])]),_:1}))}},Ve=ie(fe,[["__scopeId","data-v-87066c0d"]]),ye={class:"text-right mt-3"},be={__name:"OxPasswordEdit",props:{user:{type:Object}},emits:["save","saved"],setup(m,{emit:c}){const p=S("repos"),_=m,u=M({value:"",show:!1}),d=M({value:"",show:!1}),f=M(new X),y=C(()=>u.value&&d.value&&u.value==d.value);function g(){u.value="",d.value="",f.none()}async function l(){f.processing();try{const o=await p.users.api().updatePassword(_.user.id,u.value);o.response.status==200?(u.value="",d.value="",f.ok(o.response)):f.error(o.response.data)}catch(o){f.error((o==null?void 0:o.message)||o)}}return(o,s)=>(n(),v(b,null,[r(e(I),{state:f},null,8,["state"]),r($,{variant:"underlined",label:"Enter password",modelValue:u.value,"onUpdate:modelValue":s[0]||(s[0]=t=>u.value=t),type:u.value?"text":"password","append-icon":u.value?"mdi-eye":"mdi-eye-off","onClick:append":s[1]||(s[1]=t=>u.value=!u.value)},null,8,["modelValue","type","append-icon"]),r($,{variant:"underlined",label:"Confirm password",modelValue:d.value,"onUpdate:modelValue":s[2]||(s[2]=t=>d.value=t),color:y.value?"success":"error",type:d.show?"text":"password","append-icon":d.show?"mdi-eye":"mdi-eye-off","onClick:append":s[3]||(s[3]=t=>d.show=!d.show)},A({_:2},[(u.value||d.value)&&!y.value?{name:"details",fn:i(()=>[s[6]||(s[6]=V("div",{class:"password-error"},"Provided passwords are not the same.",-1))]),key:"0"}:void 0]),1032,["modelValue","color","type","append-icon"]),V("div",ye,[z(o.$slots,"default",{valid:y.value,value:u.value},()=>[u.value?(n(),x(e(L),{key:0,onValidate:s[4]||(s[4]=t=>l()),onReset:s[5]||(s[5]=t=>g()),state:f,"validate-disabled":!y.value},null,8,["state","validate-disabled"])):O("",!0)])])],64))}},_e={class:"mb-3"},R=q({__name:"OxUserEdit",props:{initial:Object,saved:Function},emits:["saved"],setup(m,{emit:c}){const p=c,_=S("repos"),u=_.groups.all(),d=m,{initial:f}=H(d),y=W("form"),g=S("panels"),l=Y({name:"account-editor",panels:g,initial:f,emits:p,repo:_.users});function o(s){return/^[A-Za-z0-9@.+\-_]+$/.test(s)||"Username must not be empty. It only can contain letters, numbers and @/+/./- special characters"}return(s,t)=>(n(),x(ne,null,{default:i(()=>[r(e(I),{state:e(l).state},null,8,["state"]),V("div",_e,[e(l).edited?(n(),x(e(L),{key:0,onValidate:t[0]||(t[0]=a=>e(l).save()),onReset:t[1]||(t[1]=a=>e(l).reset()),state:e(l).state,"validate-disabled":!e(y).isValid},null,8,["state","validate-disabled"])):O("",!0)]),r(re,{mandatory:"",multiple:"","model-value":["info"]},{default:i(()=>[r(N,{title:"Information",value:"info"},{text:i(()=>[r(ue,{ref_key:"form",ref:y,modelValue:e(l).valid,"onUpdate:modelValue":t[7]||(t[7]=a=>e(l).valid=a)},{default:i(()=>[r($,{variant:"underlined",label:"User Name",modelValue:e(l).value.username,"onUpdate:modelValue":t[2]||(t[2]=a=>e(l).value.username=a),rules:[o]},{details:i(()=>{var a;return[r(e(h),{errors:(a=e(l).errors)==null?void 0:a.username},null,8,["errors"])]}),_:1},8,["modelValue","rules"]),r($,{variant:"underlined",label:"First Name",modelValue:e(l).value.first_name,"onUpdate:modelValue":t[3]||(t[3]=a=>e(l).value.first_name=a)},{details:i(()=>{var a;return[r(e(h),{errors:(a=e(l).errors)==null?void 0:a.first_name},null,8,["errors"])]}),_:1},8,["modelValue"]),r($,{variant:"underlined",label:"Last Name",modelValue:e(l).value.last_name,"onUpdate:modelValue":t[4]||(t[4]=a=>e(l).value.last_name=a)},{details:i(()=>{var a;return[r(e(h),{errors:(a=e(l).errors)==null?void 0:a.last_name},null,8,["errors"])]}),_:1},8,["modelValue"]),r($,{variant:"underlined",type:"email",label:"Email",modelValue:e(l).value.email,"onUpdate:modelValue":t[5]||(t[5]=a=>e(l).value.email=a)},{details:i(()=>{var a;return[r(e(h),{errors:(a=e(l).errors)==null?void 0:a.email},null,8,["errors"])]}),_:1},8,["modelValue"]),r(D,{multiple:"",label:"Groups",modelValue:e(l).value.groups_id,"onUpdate:modelValue":t[6]||(t[6]=a=>e(l).value.groups_id=a),items:e(u),"item-title":"name","item-value":"id"},null,8,["modelValue","items"])]),_:1},8,["modelValue"])]),_:1}),e(l).value.id?(n(),x(N,{key:0,title:"User permissions"},{text:i(()=>[r(F,null,{default:i(()=>[r(Ve,{user:e(l).value,modelValue:e(l).value.permissions_id,"onUpdate:modelValue":t[8]||(t[8]=a=>e(l).value.permissions_id=a)},null,8,["user","modelValue"])]),_:1})]),_:1})):O("",!0),e(l).value.id?(n(),x(N,{key:1,title:"Password reset"},{text:i(()=>[r(F,null,{default:i(()=>[r(be,{user:d.initial,onSaved:t[9]||(t[9]=()=>{})},null,8,["user"])]),_:1})]),_:1})):O("",!0)]),_:1})]),_:1}))}});function ge(m=[]){const{repos:c,models:p}=ee([E.User,E.Group,E.Permission,E.ContentType,...m]);return c.contentTypes.api().get("ox/core/content_type/"),c.permissions.api().get("ox/core/permission/"),{repos:c,models:p}}const xe={__name:"OxUserPanel",props:le.useModelPanelProps({name:"user-panel",relations:["groups"],headers:["id","username","first_name","last_name","email","groups"]}),setup(m){const c=S("context"),p=Z(),_=Object.keys(p).filter(l=>!["list.filters","item.groups"].includes(l)),{repos:u,models:d}=ge();te(u.groups).all({dataKey:"results"});const f=C(()=>u.groups.all()),y=C(()=>[{title:"Without group",value:null},...f.value.map(l=>({title:l.name,value:l.id}))]),g=m;return(l,o)=>(n(),x(e(se),{name:g.name,icon:"mdi-account",repo:e(u).users,headers:g.headers,relations:g.relations,search:"search"},A({"list.filters":i(({list:s,filters:t})=>[r(D,{class:"ml-3",density:"compact",modelValue:t.groups__id__in,"onUpdate:modelValue":a=>t.groups__id__in=a,multiple:"",label:"Groups",items:f.value,"item-title":"$title","item-value":"id","hide-details":""},null,8,["modelValue","onUpdate:modelValue","items"]),z(l.$slots,"list.filters",{list:s,filters:t})]),"views.list.kanban":i(({panel:s,items:t,list:a})=>[r(e(ae),{field:"groups_id",headers:y.value,"item-title":"username",onClick:w=>s.show({path:".detail.edit",value:w})},null,8,["headers","onClick"])]),_:2},[k(e(_),s=>({name:s,fn:i(t=>[z(l.$slots,s,J(Q(t)))])})),e(p)["item.groups"]?void 0:{name:"item.groups",fn:i(({item:s})=>[(n(!0),v(b,null,k(s.groups,t=>(n(),x(T,{color:"primary",variant:"tonal",class:"mr-2"},{default:i(()=>[j(U(t.name),1)]),_:2},1024))),256))]),key:"0"},!e(p)["views.detail.add"]&&e(c).user.can("auth.add_user")?{name:"views.detail.add",fn:i(({value:s,saved:t})=>[r(R,{initial:s,onSaved:t},null,8,["initial","onSaved"])]),key:"1"}:void 0,e(c).user.can("auth.change_user")?{name:"views.detail.edit.window.default",fn:i(({value:s})=>[r(R,{initial:s},null,8,["initial"])]),key:"2"}:void 0]),1032,["name","repo","headers","relations"]))}},Ue=Object.freeze(Object.defineProperty({__proto__:null,default:xe},Symbol.toStringTag,{value:"Module"}));export{Ve as O,R as _,xe as a,Ue as b,ge as u};
//# sourceMappingURL=OxUserPanel.js.map
